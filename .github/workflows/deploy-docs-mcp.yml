name: ðŸš€ Docs MCP Server Deployment

run-name: "ðŸš€ Deploy Docs MCP to ${{ github.event.inputs.target_environment || 'staging' }} from ${{ github.ref_name }}"

on:
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Target environment for deployment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read
  deployments: write
  actions: write
  id-token: write  # Required for AWS OIDC authentication

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  setup:
    name: "Environment"
    runs-on: [ubuntu-latest]
    environment: ${{ github.event.inputs.target_environment }}
    outputs:
      environment_name: ${{ steps.env-detection.outputs.environment_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "ðŸŽ¯ Detect Environment"
        id: env-detection
        run: |
          TARGET_ENV="${{ github.event.inputs.target_environment }}"
          echo "ðŸŽ¯ Target environment: $TARGET_ENV"
          
          # Validate environment
          case "$TARGET_ENV" in
            "staging"|"production")
              echo "âœ… Valid environment: $TARGET_ENV"
              ;;
            *)
              echo "âŒ Invalid environment: $TARGET_ENV"
              echo "Valid environments: staging, production"
              exit 1
              ;;
          esac
          
          echo "environment_name=$TARGET_ENV" >> $GITHUB_OUTPUT

  build:
    name: "ðŸ”¨ Build"
    needs: [setup]
    runs-on: [ubuntu-latest]
    environment: ${{ needs.setup.outputs.environment_name }}
    permissions:
      actions: read
      contents: read
      id-token: write  # Required for AWS OIDC authentication

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Configure AWS credentials using OIDC (no access keys needed)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: "ðŸ³ Build & Push docs-mcp (ECR)"
        uses: docker/build-push-action@v6
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY || 'journium/docs-mcp' }}
          ENVIRONMENT_NAME: ${{ needs.setup.outputs.environment_name }}
        with:
          context: .
          file: apps/docs-mcp/Dockerfile
          platforms: linux/arm64
          push: true
          provenance: false
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY || 'journium/docs-mcp' }}:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY || 'journium/docs-mcp' }}:${{ needs.setup.outputs.environment_name }}
            ${{ github.ref == 'refs/heads/main' && format('{0}/{1}:latest', steps.login-ecr.outputs.registry, vars.ECR_REPOSITORY || 'journium/docs-mcp') || '' }}
          cache-from: |
            type=registry,ref=${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY || 'journium/docs-mcp' }}:buildcache
            type=registry,ref=${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY || 'journium/docs-mcp' }}:${{ needs.setup.outputs.environment_name }}
            type=registry,ref=${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY || 'journium/docs-mcp' }}:latest
          cache-to: type=registry,ref=${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY || 'journium/docs-mcp' }}:buildcache,mode=max

  deploy-staging:
    name: "ðŸš€ Deploy to Staging"
    needs: [setup, build]
    if: ${{ !failure() && !cancelled() && needs.setup.outputs.environment_name == 'staging' }}
    runs-on: [ubuntu-latest]
    environment:
      name: ${{ needs.setup.outputs.environment_name }}
      url: https://docs-mcp.staging.journium.app
    permissions:
      actions: read
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Configure AWS credentials using OIDC
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Install AWS Copilot CLI
        run: |
          echo "ðŸ“¦ Installing AWS Copilot CLI..."
          curl -Lo /tmp/copilot-cli https://github.com/aws/copilot-cli/releases/latest/download/copilot-linux
          chmod +x /tmp/copilot-cli
          sudo mv /tmp/copilot-cli /usr/local/bin/copilot
          copilot --version
          echo "âœ… Copilot CLI installed successfully"

      - name: "ðŸš€ Deploy docs-mcp to staging"
        env:
          APP_NAME: ${{ vars.COPILOT_APP_NAME || 'journium' }}
          ENV_NAME: ${{ needs.setup.outputs.environment_name }}
          SERVICE_NAME: docs-mcp
        run: |
          set -e
          set -o pipefail
          
          echo "ðŸš€ Deploying ${SERVICE_NAME} to ${ENV_NAME} environment"
          echo "ðŸ“¦ App: ${APP_NAME}"
          echo ""
          
          copilot svc deploy \
            --app ${APP_NAME} \
            --env ${ENV_NAME} \
            --name ${SERVICE_NAME} \
            --force
          
          echo ""
          echo "âœ… Deployment completed successfully!"

      - name: "ðŸ“Š Get Service Status"
        if: always()
        env:
          APP_NAME: ${{ vars.COPILOT_APP_NAME || 'journium' }}
          ENV_NAME: ${{ needs.setup.outputs.environment_name }}
          SERVICE_NAME: docs-mcp
        run: |
          echo "ðŸ“Š Getting service status..."
          copilot svc status \
            --app ${APP_NAME} \
            --env ${ENV_NAME} \
            --name ${SERVICE_NAME} || true

  deploy-production:
    name: "ðŸš€ Deploy to Production"
    needs: [setup, build]
    if: ${{ !failure() && !cancelled() && needs.setup.outputs.environment_name == 'production' }}
    runs-on: [ubuntu-latest]
    environment:
      name: ${{ needs.setup.outputs.environment_name }}
      url: https://docs-mcp.journium.app
    permissions:
      actions: read
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Configure AWS credentials using OIDC
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Install AWS Copilot CLI
        run: |
          echo "ðŸ“¦ Installing AWS Copilot CLI..."
          curl -Lo /tmp/copilot-cli https://github.com/aws/copilot-cli/releases/latest/download/copilot-linux
          chmod +x /tmp/copilot-cli
          sudo mv /tmp/copilot-cli /usr/local/bin/copilot
          copilot --version
          echo "âœ… Copilot CLI installed successfully"

      - name: "ðŸš€ Deploy docs-mcp to production"
        env:
          APP_NAME: ${{ vars.COPILOT_APP_NAME || 'journium' }}
          ENV_NAME: ${{ needs.setup.outputs.environment_name }}
          SERVICE_NAME: docs-mcp
        run: |
          set -e
          set -o pipefail
          
          echo "ðŸš€ Deploying ${SERVICE_NAME} to ${ENV_NAME} environment"
          echo "ðŸ“¦ App: ${APP_NAME}"
          echo ""
          
          copilot svc deploy \
            --app ${APP_NAME} \
            --env ${ENV_NAME} \
            --name ${SERVICE_NAME} \
            --force
          
          echo ""
          echo "âœ… Deployment completed successfully!"

      - name: "ðŸ“Š Get Service Status"
        if: always()
        env:
          APP_NAME: ${{ vars.COPILOT_APP_NAME || 'journium' }}
          ENV_NAME: ${{ needs.setup.outputs.environment_name }}
          SERVICE_NAME: docs-mcp
        run: |
          echo "ðŸ“Š Getting service status..."
          copilot svc status \
            --app ${APP_NAME} \
            --env ${ENV_NAME} \
            --name ${SERVICE_NAME} || true

  summary:
    name: "ðŸ“Š Deployment Summary"
    needs: [setup, build, deploy-staging, deploy-production]
    runs-on: [ubuntu-latest]
    if: always()
    steps:
      - name: "ðŸ“Š Generate Deployment Report"
        run: |
          echo "## ðŸš€ Docs MCP Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.setup.outputs.environment_name }}" = "production" ]; then
            echo "âš ï¸ **PRODUCTION DEPLOYMENT** âš ï¸" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ðŸŽ¯ ${{ needs.setup.outputs.environment_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Status:** ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          
          # Check which deploy job actually ran
          if [ "${{ needs.deploy-staging.result }}" == "success" ] || [ "${{ needs.deploy-staging.result }}" == "failure" ]; then
            echo "**Deploy Status:** ${{ needs.deploy-staging.result }} (Staging)" >> $GITHUB_STEP_SUMMARY
            DEPLOY_RESULT="${{ needs.deploy-staging.result }}"
          elif [ "${{ needs.deploy-production.result }}" == "success" ] || [ "${{ needs.deploy-production.result }}" == "failure" ]; then
            echo "**Deploy Status:** ${{ needs.deploy-production.result }} (Production)" >> $GITHUB_STEP_SUMMARY
            DEPLOY_RESULT="${{ needs.deploy-production.result }}"
          else
            echo "**Deploy Status:** Not executed" >> $GITHUB_STEP_SUMMARY
            DEPLOY_RESULT="skipped"
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$DEPLOY_RESULT" == "success" ]; then
            echo "âœ… **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Service URL:**" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.setup.outputs.environment_name }}" = "production" ]; then
              echo "- Docs MCP: https://docs-mcp.journium.app" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸŽ‰ **Production deployment completed** - Changes are now live" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Docs MCP: https://docs-mcp.staging.journium.app" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ§ª **Staging deployment completed** - Ready for testing" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Deployment had issues. Check individual job logs for details.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Check the failed job logs above for specific error messages" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify all required secrets are properly configured" >> $GITHUB_STEP_SUMMARY
            echo "3. Ensure AWS resources are accessible and properly configured" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Deployment triggered by: ${{ github.event_name }} on ${{ github.ref_name }}*" >> $GITHUB_STEP_SUMMARY
