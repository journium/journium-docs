import type { ReactNode } from 'react';
import { readFile } from 'node:fs/promises';
import type { ImageResponseOptions } from '@takumi-rs/image-response';

export interface GenerateProps {
  title: ReactNode;
  description?: ReactNode;
}

const font = readFile('./lib/og/Geist-Regular.ttf').then((data) => ({
  name: 'Mono',
  data,
  weight: 400,
}));
const fontBold = readFile('./lib/og/Geist-Bold.ttf').then((data) => ({
  name: 'Mono',
  data,
  weight: 600,
}));

export async function getImageResponseOptions(): Promise<ImageResponseOptions> {
  return {
    width: 2400,
    height: 1260,
    format: 'png',
    fonts: await Promise.all([font, fontBold]),
  };
}

export function generate({ title, description }: GenerateProps) {
  // Truncate title to 18 characters max and add ellipsis if needed
  const MAX_TITLE_LENGTH = 18;
  const truncatedTitle = title && typeof title === 'string' && title.length > MAX_TITLE_LENGTH
    ? title.substring(0, MAX_TITLE_LENGTH).trim() + '...'
    : title;

  // Truncate description to 133 characters max and add ellipsis if needed
  const MAX_DESCRIPTION_LENGTH = 133;
  const truncatedDescription = description && typeof description === 'string' && description.length > MAX_DESCRIPTION_LENGTH
    ? description.substring(0, MAX_DESCRIPTION_LENGTH).trim() + '...'
    : description;

  const logo = (
    <svg width="600" height="148" viewBox="0 0 3250 800" xmlns="http://www.w3.org/2000/svg">
      <g>
        <g opacity="1">
          <path d="M762.994 522.051C725.594 522.051 697.544 512.871 678.844 494.511C660.144 476.151 650.794 451.671 650.794 421.071C650.794 414.271 651.219 407.301 652.069 400.161C652.919 393.021 654.194 386.731 655.894 381.291L745.654 377.211C744.294 381.971 743.189 387.666 742.339 394.296C741.489 400.926 741.064 406.791 741.064 411.891C741.064 425.831 743.954 435.606 749.734 441.216C755.514 446.826 763.334 449.631 773.194 449.631C790.194 449.631 804.389 443.936 815.779 432.546C827.169 421.156 835.244 403.731 840.004 380.271L888.454 151.791L977.194 151.791L928.744 382.311C918.204 432.291 898.824 468.076 870.604 489.666C842.384 511.256 806.514 522.051 762.994 522.051Z" fill="white" fillRule="nonzero" opacity="1" stroke="none"/>
          <path d="M1085.31 520.011C1047.91 520.011 1019.61 511.171 1000.4 493.491C981.189 475.811 971.584 450.821 971.584 418.521C971.584 393.361 974.899 369.646 981.529 347.376C988.159 325.106 998.274 305.386 1011.87 288.216C1025.47 271.046 1042.9 257.616 1064.15 247.926C1085.4 238.236 1110.64 233.391 1139.88 233.391C1177.62 233.391 1206.1 242.316 1225.31 260.166C1244.52 278.016 1254.12 303.091 1254.12 335.391C1254.12 360.551 1250.81 384.266 1244.18 406.536C1237.55 428.806 1227.35 448.441 1213.58 465.441C1199.81 482.441 1182.3 495.786 1161.05 505.476C1139.8 515.166 1114.55 520.011 1085.31 520.011ZM1097.55 455.241C1110.47 455.241 1121.95 450.311 1131.98 440.451C1142.01 430.591 1149.83 417.331 1155.44 400.671C1161.05 384.011 1163.85 365.651 1163.85 345.591C1163.85 313.971 1151.95 298.161 1128.15 298.161C1114.89 298.161 1103.25 303.091 1093.22 312.951C1083.19 322.811 1075.45 336.071 1070.01 352.731C1064.57 369.391 1061.85 387.921 1061.85 408.321C1061.85 439.601 1073.75 455.241 1097.55 455.241Z" fill="white" fillRule="nonzero" opacity="1" stroke="none"/>
          <path d="M1354.08 520.011C1330.96 520.011 1313.28 514.146 1301.04 502.416C1288.8 490.686 1282.68 474.961 1282.68 455.241C1282.68 444.701 1283.53 434.501 1285.23 424.641C1286.93 414.781 1288.8 405.261 1290.84 396.081L1323.99 239.511L1411.71 239.511L1380.09 387.411C1379.07 393.191 1377.97 399.566 1376.78 406.536C1375.59 413.506 1374.99 420.391 1374.99 427.191C1374.99 443.511 1383.66 451.671 1401 451.671C1414.94 451.671 1426.67 446.826 1436.19 437.136C1445.71 427.446 1452.51 412.231 1456.59 391.491L1489.23 239.511L1576.95 239.511L1518.81 513.891L1439.76 513.891L1447.41 469.521C1426.33 503.181 1395.22 520.011 1354.08 520.011Z" fill="white" fillRule="nonzero" opacity="1" stroke="none"/>
          <path d="M1581.03 513.891L1639.17 239.511L1723.32 239.511L1713.12 296.121C1722.98 276.401 1734.12 262.036 1746.53 253.026C1758.94 244.016 1773.64 239.511 1790.64 239.511L1814.61 239.511L1799.82 310.401L1774.83 310.401C1753.41 310.401 1736.75 314.311 1724.85 322.131C1712.95 329.951 1704.79 343.721 1700.37 363.441L1668.75 513.891L1581.03 513.891Z" fill="white" fillRule="nonzero" opacity="1" stroke="none"/>
          <path d="M1793.19 513.891L1851.84 239.511L1930.38 239.511L1923.24 282.861C1934.46 264.841 1947.72 252.091 1963.02 244.611C1978.32 237.131 1994.64 233.391 2011.98 233.391C2035.78 233.391 2054.06 239.596 2066.81 252.006C2079.56 264.416 2085.93 281.841 2085.93 304.281C2085.93 314.821 2084.83 326.551 2082.62 339.471C2080.41 352.391 2078.28 363.441 2076.24 372.621L2045.64 513.891L1957.92 513.891L1989.54 368.031C1990.9 361.571 1992.18 354.856 1993.37 347.886C1994.56 340.916 1995.15 334.201 1995.15 327.741C1995.15 310.401 1985.8 301.731 1967.1 301.731C1953.5 301.731 1942.03 307.426 1932.68 318.816C1923.33 330.206 1916.61 346.441 1912.53 367.521L1880.91 513.891L1793.19 513.891Z" fill="white" fillRule="nonzero" opacity="1" stroke="none"/>
          <path d="M2106.33 513.891L2164.47 239.511L2252.19 239.511L2194.05 513.891L2106.33 513.891ZM2169.57 208.911L2183.34 143.631L2273.61 143.631L2260.35 208.911L2169.57 208.911Z" fill="white" fillRule="nonzero" opacity="1" stroke="none"/>
          <path d="M2335.83 520.011C2312.71 520.011 2295.03 514.146 2282.79 502.416C2270.55 490.686 2264.43 474.961 2264.43 455.241C2264.43 444.701 2265.28 434.501 2266.98 424.641C2268.68 414.781 2270.55 405.261 2272.59 396.081L2305.74 239.511L2393.46 239.511L2361.84 387.411C2360.82 393.191 2359.72 399.566 2358.53 406.536C2357.34 413.506 2356.74 420.391 2356.74 427.191C2356.74 443.511 2365.41 451.671 2382.75 451.671C2396.69 451.671 2408.42 446.826 2417.94 437.136C2427.46 427.446 2434.26 412.231 2438.34 391.491L2470.98 239.511L2558.7 239.511L2500.56 513.891L2421.51 513.891L2429.16 469.521C2408.08 503.181 2376.97 520.011 2335.83 520.011Z" fill="white" fillRule="nonzero" opacity="1" stroke="none"/>
          <path d="M2562.78 513.891L2621.43 239.511L2699.97 239.511L2692.83 282.351C2702.69 266.711 2714.08 254.641 2727 246.141C2739.92 237.641 2754.03 233.391 2769.33 233.391C2790.07 233.391 2805.88 238.236 2816.76 247.926C2827.64 257.616 2834.27 271.471 2836.65 289.491C2857.05 252.091 2885.1 233.391 2920.8 233.391C2944.6 233.391 2962.62 239.851 2974.86 252.771C2987.1 265.691 2993.22 282.861 2993.22 304.281C2993.22 313.461 2992.2 324.596 2990.16 337.686C2988.12 350.776 2985.91 362.421 2983.53 372.621L2953.44 513.891L2865.72 513.891L2896.83 368.031C2898.19 361.231 2899.55 354.431 2900.91 347.631C2902.27 340.831 2902.95 334.031 2902.95 327.231C2902.95 318.391 2900.66 311.931 2896.07 307.851C2891.48 303.771 2885.27 301.731 2877.45 301.731C2866.23 301.731 2856.46 307.086 2848.13 317.796C2839.8 328.506 2833.59 343.721 2829.51 363.441L2797.38 513.891L2718.84 513.891L2750.97 363.441C2752.33 357.321 2753.44 350.946 2754.29 344.316C2755.14 337.686 2755.56 332.331 2755.56 328.251C2755.56 310.571 2746.72 301.731 2729.04 301.731C2717.82 301.731 2708.3 307.086 2700.48 317.796C2692.66 328.506 2686.71 343.721 2682.63 363.441L2650.5 513.891L2562.78 513.891Z" fill="white" fillRule="nonzero" opacity="1" stroke="none"/>
        </g>
        <g opacity="1">
          <path d="M111.728 514.487L269.685 514.487L269.685 645.454L111.728 645.454L111.728 514.487Z" fill="white" fillRule="nonzero" opacity="1" stroke="none"/>
          <path d="M430.226 156.258L588.183 156.258L588.183 287.224L430.226 287.224L430.226 156.258Z" fill="white" fillRule="nonzero" opacity="1" stroke="none"/>
          <path d="M159.756 574.684L430.134 157.035L540.633 228.011L270.255 645.66L159.756 574.684Z" fill="white" fillRule="nonzero" opacity="1" stroke="none"/>
        </g>
      </g>
    </svg>
  );

  return (
    <div
      style={{
        display: 'flex',
        flexDirection: 'column',
        width: '100%',
        height: '100%',
        color: 'white',
        backgroundColor: 'rgb(10,10,10)',
      }}
    >
      <div
        style={{
          display: 'flex',
          flexDirection: 'column',
          width: '100%',
          height: '100%',
          padding: '8rem',
        }}
      >
        <span
          style={{
            fontWeight: 600,
            fontSize: '152px',
          }}
        >
          {truncatedTitle}
        </span>
        <p
          style={{
            fontSize: '96px',
            color: 'rgba(240,240,240,0.7)',
          }}
        >
          {truncatedDescription}
        </p>
        <div
          style={{
            display: 'flex',
            flexDirection: 'row',
            alignItems: 'center',
            marginTop: 'auto',
          }}
        >
          {logo}
        </div>
      </div>
    </div>
  );
}
